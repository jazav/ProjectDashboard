SELECT CONCAT_WS('-', prj.pkey, ji.issuenum) AS 'Key', ji.SUMMARY AS 'Summary', pr.pname AS 'Priority', ist.pname AS 'Status', cmp.cname AS 'Domain',
	(CASE WHEN CONCAT_WS('-', prj.pkey, ji.issuenum) IN (reopened.jira_key) THEN reopened.change_date ELSE CONVERT(date, ji.CREATED) END) AS 'Days on fix'
FROM [srv-jira-prod-report].[dbo].[jiraissue] AS ji
	INNER JOIN [srv-jira-prod-report].[dbo].[project] AS prj ON prj.ID = ji.PROJECT
	INNER JOIN [srv-jira-prod-report].[dbo].[issuetype] AS it ON it.ID = ji.issuetype
	INNER JOIN [srv-jira-prod-report].[dbo].[issuestatus] AS ist ON ist.ID = ji.issuestatus
	INNER JOIN [srv-jira-prod-report].[dbo].[priority] AS pr ON pr.ID = ji.PRIORITY
	INNER JOIN [srv-jira-prod-report].[dbo].[nodeassociation] AS na ON na.SOURCE_NODE_ID = ji.ID
	INNER JOIN [srv-jira-prod-report].[dbo].[component] AS cmp ON cmp.ID = na.SINK_NODE_ID,
	(
	SELECT bugs.jira_key, CONVERT(date, chg.CREATED) AS 'change_date'
	FROM [srv-jira-prod-report].[dbo].[changegroup] AS chg
		INNER JOIN [srv-jira-prod-report].[dbo].[changeitem] AS chi ON chi.groupid = chg.ID,
		(
		SELECT CONCAT_WS('-', prj.pkey, ji.issuenum) AS 'jira_key', ji.ID
		FROM [srv-jira-prod-report].[dbo].[jiraissue] AS ji
			INNER JOIN [srv-jira-prod-report].[dbo].[project] AS prj ON prj.ID = ji.PROJECT
			INNER JOIN [srv-jira-prod-report].[dbo].[issuetype] AS it ON it.ID = ji.issuetype
			INNER JOIN [srv-jira-prod-report].[dbo].[issuestatus] AS ist ON ist.ID = ji.issuestatus
			INNER JOIN [srv-jira-prod-report].[dbo].[priority] AS pr ON pr.ID = ji.PRIORITY
		WHERE prj.pname = 'BSSBOX'
			AND it.pname = 'Bug'
			AND pr.pname IN ('Critical', 'Blocker')
			AND ji.CREATED > '2019-01-09 00:00:00.000'
			AND ist.pname != 'Closed'
		) AS bugs
	WHERE chi.FIELD = 'status'
		AND chg.issueid IN (bugs.ID)
		AND CONVERT(varchar, chi.NEWSTRING) = 'Reopened'
	) AS reopened
WHERE prj.pname = 'BSSBOX'
	AND it.pname = 'Bug'
	AND pr.pname IN ('Critical', 'Blocker')
	AND ji.CREATED > '2019-01-28 00:00:00.000'
	AND ist.pname NOT IN ('Closed', 'Resolved')
	AND na.ASSOCIATION_TYPE = 'IssueComponent'