SELECT CONCAT_WS('-', prj_b.pkey, ji_b.issuenum) AS 'Key', ji_b.SUMMARY AS 'Summary', ji_b.ASSIGNEE AS 'Assignee', pr_b.pname AS 'Priority', ist_b.pname AS 'Status', cmp_b.cname AS 'Domain',
	(CASE WHEN CONCAT_WS('-', prj_b.pkey, ji_b.issuenum) IN (reopened.jira_key) THEN reopened.change_date ELSE CONVERT(date, ji_b.CREATED) END) AS 'Days on fix'
FROM [srv-jira-prod-report].[dbo].[jiraissue] AS ji_b
	INNER JOIN [srv-jira-prod-report].[dbo].[project] AS prj_b ON prj_b.ID = ji_b.PROJECT
	INNER JOIN [srv-jira-prod-report].[dbo].[issuetype] AS it_b ON it_b.ID = ji_b.issuetype
	INNER JOIN [srv-jira-prod-report].[dbo].[issuestatus] AS ist_b ON ist_b.ID = ji_b.issuestatus
	INNER JOIN [srv-jira-prod-report].[dbo].[priority] AS pr_b ON pr_b.ID = ji_b.PRIORITY
	INNER JOIN [srv-jira-prod-report].[dbo].[nodeassociation] AS na_b ON na_b.SOURCE_NODE_ID = ji_b.ID
	INNER JOIN [srv-jira-prod-report].[dbo].[component] AS cmp_b ON cmp_b.ID = na_b.SINK_NODE_ID
	FULL JOIN (
		SELECT bugs.jira_key, CONVERT(date, chg.CREATED) AS 'change_date'
		FROM [srv-jira-prod-report].[dbo].[changegroup] AS chg
			INNER JOIN [srv-jira-prod-report].[dbo].[changeitem] AS chi ON chi.groupid = chg.ID,
			(
			SELECT CONCAT_WS('-', prj.pkey, ji.issuenum) AS 'jira_key', ji.ID
			FROM [srv-jira-prod-report].[dbo].[jiraissue] AS ji
				INNER JOIN [srv-jira-prod-report].[dbo].[project] AS prj ON prj.ID = ji.PROJECT
				INNER JOIN [srv-jira-prod-report].[dbo].[issuetype] AS it ON it.ID = ji.issuetype
				INNER JOIN [srv-jira-prod-report].[dbo].[issuestatus] AS ist ON ist.ID = ji.issuestatus
				INNER JOIN [srv-jira-prod-report].[dbo].[priority] AS pr ON pr.ID = ji.PRIORITY
			WHERE prj.pname = 'BSSBOX'
				AND it.pname = 'Bug'
				AND pr.pname IN ('Critical', 'Blocker')
				AND ji.CREATED > '2019-01-28 00:00:00.000'
				AND ist.pname != 'Closed'
			) AS bugs
		WHERE chi.FIELD = 'status'
			AND chg.issueid IN (bugs.ID)
			AND CONVERT(varchar, chi.NEWSTRING) = 'Reopened'
		) AS reopened ON reopened.jira_key = CONCAT_WS('-', prj_b.pkey, ji_b.issuenum)
WHERE prj_b.pname = 'BSSBOX'
	AND it_b.pname = 'Bug'
	AND pr_b.pname IN ('Critical', 'Blocker')
	AND ji_b.CREATED > '2019-01-28 00:00:00.000'
	AND ist_b.pname NOT IN ('Closed', 'Resolved')
	AND na_b.ASSOCIATION_TYPE = 'IssueComponent'
ORDER BY jira_key